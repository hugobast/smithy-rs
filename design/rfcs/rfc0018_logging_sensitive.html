<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RFC-0018: Logging in the Presence of Sensitive Data - AWS Rust SDK Design</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Design Overview</a></li><li class="chapter-item expanded "><a href="../tenets.html"><strong aria-hidden="true">2.</strong> Tenets</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">3.</strong> Design FAQ</a></li><li class="chapter-item expanded "><a href="../transport/overview.html"><strong aria-hidden="true">4.</strong> Transport</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../transport/operation.html"><strong aria-hidden="true">4.1.</strong> HTTP Operations</a></li><li class="chapter-item expanded "><a href="../transport/middleware.html"><strong aria-hidden="true">4.2.</strong> HTTP Middleware</a></li></ol></li><li class="chapter-item expanded "><a href="../smithy/overview.html"><strong aria-hidden="true">5.</strong> Smithy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../smithy/simple_shapes.html"><strong aria-hidden="true">5.1.</strong> Simple Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/recursive_shapes.html"><strong aria-hidden="true">5.2.</strong> Recursive Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/aggregate_shapes.html"><strong aria-hidden="true">5.3.</strong> Aggregate Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/endpoint.html"><strong aria-hidden="true">5.4.</strong> Endpoint Resolution</a></li><li class="chapter-item expanded "><a href="../smithy/backwards-compat.html"><strong aria-hidden="true">5.5.</strong> Backwards Compatibility</a></li></ol></li><li class="chapter-item expanded "><a href="../rfcs/overview.html"><strong aria-hidden="true">6.</strong> RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfcs/rfc0001_shared_config.html"><strong aria-hidden="true">6.1.</strong> RFC-0001: Sharing configuration between multiple clients</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0002_http_versions.html"><strong aria-hidden="true">6.2.</strong> RFC-0002: Supporting multiple HTTP versions for SDKs that use Event Stream</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0003_presigning_api.html"><strong aria-hidden="true">6.3.</strong> RFC-0003: API for Pre-signed URLs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0004_retry_behavior.html"><strong aria-hidden="true">6.4.</strong> RFC-0004: Retry Behavior</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0005_service_generation.html"><strong aria-hidden="true">6.5.</strong> RFC-0005: Smithy Rust service framework</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0006_service_specific_middleware.html"><strong aria-hidden="true">6.6.</strong> RFC-0006: Service-specific middleware</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0007_split_release_process.html"><strong aria-hidden="true">6.7.</strong> RFC-0007: Split release process</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0008_paginators.html"><strong aria-hidden="true">6.8.</strong> RFC-0008: Paginators</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0009_example_consolidation.html"><strong aria-hidden="true">6.9.</strong> RFC-0009: Example Consolidation</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0010_waiters.html"><strong aria-hidden="true">6.10.</strong> RFC-0010: Waiters</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0011_crates_io_alpha_publishing.html"><strong aria-hidden="true">6.11.</strong> RFC-0011: Publishing Alpha to Crates.io</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0012_independent_crate_versioning.html"><strong aria-hidden="true">6.12.</strong> RFC-0012: Independent Crate Versioning</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0013_body_callback_apis.html"><strong aria-hidden="true">6.13.</strong> RFC-0013: Body Callback APIs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0014_timeout_config.html"><strong aria-hidden="true">6.14.</strong> RFC-0014: Fine-grained timeout configuration</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0015_using_features_responsibly.html"><strong aria-hidden="true">6.15.</strong> RFC-0015: How Cargo "features" should be used in the SDK and runtime crates</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0016_flexible_checksum_support.html"><strong aria-hidden="true">6.16.</strong> RFC-0016: Supporting Flexible Checksums</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0017_customizable_client_operations.html"><strong aria-hidden="true">6.17.</strong> RFC-0017: Customizable Client Operations</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0018_logging_sensitive.html" class="active"><strong aria-hidden="true">6.18.</strong> RFC-0018: Logging in the Presence of Sensitive Data</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0019_event_streams_errors.html"><strong aria-hidden="true">6.19.</strong> RFC-0019: Event Streams Errors</a></li></ol></li><li class="chapter-item expanded "><a href="../contributing/overview.html"><strong aria-hidden="true">7.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/writing_and_debugging_a_low-level_feature_that_relies_on_HTTP.html"><strong aria-hidden="true">7.1.</strong> Writing and debugging a low-level feature that relies on HTTP</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AWS Rust SDK Design</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rfc-logging-in-the-presence-of-sensitive-data"><a class="header" href="#rfc-logging-in-the-presence-of-sensitive-data">RFC: Logging in the Presence of Sensitive Data</a></h1>
<blockquote>
<p>Status: Accepted</p>
</blockquote>
<p>Smithy provides a <a href="https://awslabs.github.io/smithy/1.0/spec/core/documentation-traits.html#sensitive-trait">sensitive trait</a> which exists as a <code>@sensitive</code> field annotation syntactically and has the following semantics:</p>
<blockquote>
<p>Sensitive data MUST NOT be exposed in things like exception messages or log output. Application of this trait SHOULD NOT affect wire logging (i.e., logging of all data transmitted to and from servers or clients).</p>
</blockquote>
<p>This RFC is concerned with solving the problem of honouring this specification in the context of logging.</p>
<p>Progress has been made towards this goal in the form of the <a href="https://github.com/awslabs/smithy-rs/pull/229">Sensitive Trait PR</a>, which uses code generation to remove sensitive fields from <code>Debug</code> implementations.</p>
<p>The problem remains open due to the existence of HTTP binding traits and a lack of clearly defined user guidelines which customers may follow to honour the specification.</p>
<p>This RFC proposes:</p>
<ul>
<li>A new logging middleware is generated and applied to each <code>OperationHandler</code> <code>Service</code>.</li>
<li>A developer guideline is provided on how to avoid violating the specification.</li>
</ul>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<ul>
<li><strong>Model</strong>: A <a href="https://awslabs.github.io/smithy/1.0/spec/core/model.html">Smithy Model</a>, usually pertaining to the one in use by the customer.</li>
<li><strong>Runtime crate</strong>: A crate existing within the <code>rust-runtime</code> folder, used to implement shared functionalities that do not have to be code-generated.</li>
<li><strong>Service</strong>: The <a href="https://docs.rs/tower-service/latest/tower_service/trait.Service.html">tower::Service</a> trait. The lowest level of abstraction we deal with when making HTTP requests. Services act directly on data to transform and modify that data. A Service is what eventually turns a request into a response.</li>
<li><strong>Middleware</strong>: Broadly speaking, middleware modify requests and responses. Concretely, these are exist as implementations of <a href="https://docs.rs/tower/latest/tower/layer/trait.Layer.html">Layer</a>/a <code>Service</code> wrapping an inner <code>Service</code>.</li>
<li><strong>Potentially sensitive</strong>: Data that <em>could</em> be bound to a sensitive field of a structure, for example via the <a href="#http-binding-traits">HTTP Binding Traits</a>.</li>
</ul>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<h3 id="http-binding-traits"><a class="header" href="#http-binding-traits">HTTP Binding Traits</a></h3>
<p>Smithy provides various HTTP binding traits. These allow protocols to configure a HTTP request by way of binding fields to parts of the request. For this reason sensitive data might be unintentionally leaked through logging of a bound request.</p>
<div class="table-wrapper"><table><thead><tr><th>Trait</th><th>Configurable</th></tr></thead><tbody>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httpheader-trait">httpHeader</a></td><td>Headers</td></tr>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httpprefixheaders-trait">httpPrefixHeaders</a></td><td>Headers</td></tr>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httplabel-trait">httpLabel</a></td><td>URI</td></tr>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httppayload-trait">httpPayload</a></td><td>Payload</td></tr>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httpquery-trait">httpQuery</a></td><td>Query Parameters</td></tr>
<tr><td><a href="https://awslabs.github.io/smithy/1.0/spec/core/http-traits.html#httpresponsecode-trait">httpResponseCode</a></td><td>Status Code</td></tr>
</tbody></table>
</div>
<p>Each of these configurable parts must therefore be logged cautiously.</p>
<h3 id="scope-and-guidelines"><a class="header" href="#scope-and-guidelines">Scope and Guidelines</a></h3>
<p>It would be unfeasible to forbid the logging of sensitive data all together using the type system. With the current API, the customer will always have an opportunity to log a request containing sensitive data before it enters the <code>Service&lt;Request&lt;B&gt;&gt;</code> that we provide to them.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// The API provides us with a `Service&lt;Request&lt;B&gt;&gt;`
let app: Router = OperationRegistryBuilder::default().build().expect(&quot;unable to build operation registry&quot;).into();

// We can `ServiceExt::map_request` log a request with potentially sensitive data
let app = app.map_request(|request| {
        info!(?request);
        request
    });
<span class="boring">}
</span></code></pre></pre>
<p>A more subtle violation of the specification may occur when the customer enables verbose logging - a third-party dependency might simply log data marked as sensitive, for example <code>tokio</code> or <code>hyper</code>.</p>
<p>These two cases illustrate that <code>smithy-rs</code> can only prevent violation of the specification in a restricted scope - logs emitted from generated code and the runtime crates. A <code>smithy-rs</code> specific guideline should be available to the customer which outlines how to avoid violating the specification in areas outside of our control.</p>
<h3 id="routing"><a class="header" href="#routing">Routing</a></h3>
<p>The sensitivity and HTTP bindings are declared within specific structures/operations. For this reason, in the general case, it's unknowable whether or not any given part of a request is sensitive until we determine which operation is tasked with handling the request and hence which fields are bound. Implementation wise, this means that any middleware applied <em>before</em> routing has taken place cannot log anything potentially sensitive without performing routing logic itself.</p>
<p>Note that:</p>
<ul>
<li>We are not required to deserialize the entire request before we can make judgments on what data is sensitive or not - only which operation it has been routed to.</li>
<li>We are permitted to emit logs prior to routing when:
<ul>
<li>they contain no potentially sensitive data, or</li>
<li>the request failed to route, in which case it's not subject to the constraints of an operation.</li>
</ul>
</li>
</ul>
<h3 id="runtime-crates"><a class="header" href="#runtime-crates">Runtime Crates</a></h3>
<p>The crates existing in <code>rust-runtime</code> are not code generated - their source code is agnostic to the specific model in use. For this reason, if such a crate wanted to log potentially sensitive data then there must be a way to conditionally toggle that log without manipulation of the source code. Any proposed solution must acknowledge this concern.</p>
<h2 id="proposal"><a class="header" href="#proposal">Proposal</a></h2>
<p>This proposal serves to honor the sensitivity specification via code generation of a logging middleware which is aware of the sensitivity, together with a developer contract disallowing logging potentially sensitive data in the runtime crates. A developer guideline should be provided in addition to the middleware.</p>
<p>All data known to be sensitive should be replaced with <code>&quot;{redacted}&quot;</code> when logged. Implementation wise this means that <a href="https://docs.rs/tracing/latest/tracing/struct.Event.html">tracing::Event</a>s and <a href="https://docs.rs/tracing/latest/tracing/struct.Span.html">tracing::Span</a>s of the form <code>debug!(field = &quot;sensitive data&quot;)</code> and <code>span!(..., field = &quot;sensitive data&quot;)</code> must become <code>debug!(field = &quot;{redacted}&quot;)</code> and <code>span!(..., field = &quot;{redacted}&quot;)</code>.</p>
<h3 id="debug-logging"><a class="header" href="#debug-logging">Debug Logging</a></h3>
<p>Developers might want to observe sensitive data for debugging purposes. It should be possible to opt-out of the redactions by enabling a feature flag <code>unredacted-logging</code> (which is disabled by default).</p>
<p>To prevent excessive branches such as</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if cfg!(feature = &quot;unredacted-logging&quot;) {
    debug!(%data, &quot;logging here&quot;);
} else {
    debug!(data = &quot;{redacted}&quot;, &quot;logging here&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<p>the following wrapper should be provided from a runtime crate:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Sensitive&lt;T&gt;(T);

impl&lt;T&gt; Debug for Sensitive&lt;T&gt;
where
    T: Debug
{
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt; {
        if cfg!(feature = &quot;unredacted-logging&quot;) {
            self.0.fmt(f)
        } else {
            &quot;{redacted}&quot;.fmt(f)
        }
    }
}

impl&lt;T&gt; Display for Sensitive&lt;T&gt;
where
    T: Display
{
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt; {
        if cfg!(feature = &quot;unredacted-logging&quot;) {
            self.0.fmt(f)
        } else {
            &quot;{redacted}&quot;.fmt(f)
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>In which case the branch above becomes</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>debug!(sensitive_data = %Sensitive(data));
<span class="boring">}
</span></code></pre></pre>
<h3 id="code-generated-logging-middleware"><a class="header" href="#code-generated-logging-middleware">Code Generated Logging Middleware</a></h3>
<p>Using the smithy model, for each operation, a logging middleware should be generated. Through the model, the code generation knows which fields are sensitive and which HTTP bindings exist, therefore the logging middleware can be carefully crafted to avoid leaking sensitive data.</p>
<p>As a request enters this middleware it should record the method, HTTP headers, status code, and URI in a <code>tracing::span</code>. As a response leaves this middleware it should record the HTTP headers and status code in a <code>tracing::debug</code>.</p>
<p>The following model</p>
<pre><code class="language-smithy">@readonly
@http(uri: &quot;/inventory/{name}&quot;, method: &quot;GET&quot;)
operation Inventory {
    input: Product,
    output: Stocked
}

@input
structure Product {
    @required
    @sensitive
    @httpLabel
    name: String
}

@output
structure Stocked {
    @sensitive
    @httpResponseCode
    code: String,
}
</code></pre>
<p>should generate the following</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// NOTE: This code is intended to show behavior - it does not compile

pub struct InventoryLogging&lt;S&gt; {
    inner: S,
    operation_name: &amp;'static str
}

impl&lt;S&gt; InventoryLogging&lt;S&gt; {
    pub fn new(inner: S) -&gt; Self {
        Self {
            inner
        }
    }
}

impl&lt;B, S&gt; Service&lt;Request&lt;B&gt;&gt; for InventoryLogging&lt;S&gt;
where
    S: Service&lt;Request&lt;B&gt;&gt;
{
    type Response = Response&lt;BoxBody&gt;;
    type Error = S::Error;
    type Future = /* Implementation detail */;

    fn call(&amp;mut self, request: Request&lt;B&gt;) -&gt; Self::Future {
        // Remove sensitive data from parts of the HTTP
        let uri = /* redact {name} from URI */;
        let headers = /* no redactions */;

        let fut = async {
            let response = self.inner.call(request).await;
            let status_code = /* redact status code */;
            let headers = /* no redactions */;

            debug!(%status_code, ?headers, &quot;response&quot;);

            response
        };

        // Instrument the future with a span
        let span = debug_span!(&quot;request&quot;, operation = %self.operation_name, method = %request.method(), %uri, ?headers);
        fut.instrument(span)
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="http-debugdisplay-wrappers"><a class="header" href="#http-debugdisplay-wrappers">HTTP Debug/Display Wrappers</a></h3>
<p>The <code>Service::call</code> path, seen in <a href="#code-generated-logging-middleware">Code Generated Logging Middleware</a>, is latency-sensitive. Careful implementation is required to avoid excess allocations during redaction of sensitive data. Wrapping <a href="https://docs.rs/http/latest/http/uri/struct.Uri.html">Uri</a> and <a href="https://docs.rs/http/latest/http/header/struct.HeaderMap.html">HeaderMap</a> then providing a new <a href="https://doc.rust-lang.org/std/fmt/trait.Display.html">Display</a>/<a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html">Debug</a> implementation which skips over the sensitive data is preferable over allocating a new <code>String</code>/<code>HeaderMap</code> and then mutating it.</p>
<p>These wrappers should be provided alongside the <code>Sensitive</code> struct described in <a href="#debug-logging">Debug Logging</a>. If they are implemented on top of <code>Sensitive</code>, they will inherit the same behavior - allowing redactions to be toggled using <code>unredacted-logging</code> feature flag.</p>
<h3 id="middleware-position"><a class="header" href="#middleware-position">Middleware Position</a></h3>
<p>This logging middleware should be applied outside of the <a href="https://github.com/awslabs/smithy-rs/blob/cd0563020abcde866a741fa123e3f2e18e1be1c9/rust-runtime/inlineable/src/server_operation_handler_trait.rs#L17-L21">OperationHandler</a> after its construction in the (generated) <code>operation_registry.rs</code> file. The middleware should preserve the associated types of the <code>OperationHandler</code> (<code>Response = Response&lt;BoxBody&gt;</code>, <code>Error = Infallible</code>) to cause minimal disruption.</p>
<p>An easy position to apply the logging middleware is illustrated below in the form of <code>Logging{Operation}::new</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let empty_operation = LoggingEmptyOperation::new(operation(registry.empty_operation));
let get_pokemon_species = LoggingPokemonSpecies::new(operation(registry.get_pokemon_species));
let get_server_statistics = LoggingServerStatistics::new(operation(registry.get_server_statistics));
let routes = vec![
    (BoxCloneService::new(empty_operation), empty_operation_request_spec),
    (BoxCloneService::new(get_pokemon_species), get_pokemon_species_request_spec),
    (BoxCloneService::new(get_server_statistics), get_server_statistics_request_spec),
];
let router = aws_smithy_http_server::routing::Router::new_rest_json_router(routes);
<span class="boring">}
</span></code></pre></pre>
<p>Although an acceptable first step, putting logging middleware here is suboptimal - the <code>Router</code> allows a <code>tower::Layer</code> to be applied to the operation by using the <a href="https://github.com/awslabs/smithy-rs/blob/main/rust-runtime/aws-smithy-http-server/src/routing/mod.rs#L146">Router::layer</a> method. This middleware will be applied <em>outside</em> of the logging middleware and, as a result, will not be subject to the span of any middleware. Therefore, the <code>Router</code> must be changed to allow for middleware to be applied within the logging middleware rather than outside of it.</p>
<p>This is a general problem, not specific to this proposal. For example, <a href="#use-request-extensions">Use Request Extensions</a> must also solve this problem.</p>
<p>Fortunately, this problem is separable from the actual implementation of the logging middleware and we can get immediate benefit by application of it in the suboptimal position described above.</p>
<h3 id="logging-within-the-router"><a class="header" href="#logging-within-the-router">Logging within the Router</a></h3>
<p>There is need for logging within the <code>Router</code> implementation - this is a crucial area of business logic. As mentioned in the <a href="#routing">Routing</a> section, we are permitted to log potentially sensitive data in cases where requests fail to get routed to an operation.</p>
<p>In the case of AWS JSON 1.0 and 1.1 protocols, the request URI is always <code>/</code>, putting it outside of the reach of the <code>@sensitive</code> trait. We therefore have the option to log it before routing occurs. We make a choice not to do this in order to remove the special case - relying on the logging layer to log URIs when appropriate.</p>
<h3 id="developer-guideline"><a class="header" href="#developer-guideline">Developer Guideline</a></h3>
<p>A guideline should be made available, which includes:</p>
<ul>
<li>The <a href="#http-binding-traits">HTTP bindings traits</a> and why they are of concern in the presence of <code>@sensitive</code>.</li>
<li>The <a href="https://github.com/awslabs/smithy-rs/pull/229">Debug implementation</a> on structures.</li>
<li>How to use the <code>Sensitive</code> struct, HTTP wrappers, and the <code>unredacted-logging</code> feature flag described in <a href="#debug-logging">Debug Logging</a> and <a href="#http-debugdisplay-wrappers">HTTP Debug/Display Wrappers</a>.</li>
<li>A warning against the two potential leaks described in <a href="#scope-and-guidelines">Scope and Guidelines</a>:
<ul>
<li>Sensitive data leaking from third-party dependencies.</li>
<li>Sensitive data leaking from middleware applied to the <code>Router</code>.</li>
</ul>
</li>
</ul>
<h2 id="alternative-proposals"><a class="header" href="#alternative-proposals">Alternative Proposals</a></h2>
<p>All of the following proposals are compatible with, and benefit from, <a href="#debug-logging">Debug Logging</a>, <a href="#http-debugdisplay-wrappers">HTTP Debug/Display Wrappers</a>, and <a href="#developer-guideline">Developer Guideline</a> portions of the main proposal.</p>
<p>The main proposal disallows the logging of potentially sensitive data in the runtime crates, instead opting for a dedicated code generated logging middleware. In contrast, the following proposals all seek ways to accommodate logging of potentially sensitive data in the runtime crates.</p>
<h3 id="use-request-extensions"><a class="header" href="#use-request-extensions">Use Request Extensions</a></h3>
<p>Request extensions can be used to adjoin data to a Request as it passes through the middleware. Concretely, they exist as the type map <a href="https://docs.rs/http/latest/http/struct.Extensions.html">http::Extensions</a> accessed via <a href="https://docs.rs/http/latest/http/request/struct.Request.html#method.extensions">http::extensions</a> and <a href="https://docs.rs/http/latest/http/request/struct.Request.html#method.extensions_mut">http::extensions_mut</a>.</p>
<p>These can be used to provide data to middleware interested in logging potentially sensitive data.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Sensitivity {
    /* Data concerning which parts of the request are sensitive */
}

struct Middleware&lt;S&gt; {
    inner: S
}

impl&lt;B, S&gt; Service&lt;Request&lt;B&gt;&gt; for Middleware&lt;S&gt; {
    /* ... */

    fn call(&amp;mut self, request: Request&lt;B&gt;) -&gt; Self::Future {
        if let Some(sensitivity) = request.extensions().get::&lt;Sensitivity&gt;() {
            if sensitivity.is_method_sensitive() {
                debug!(method = %request.method());
            }
        }

        /* ... */

        self.inner.call(request)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>A middleware layer must be code generated (much in the same way as the logging middleware) which is dedicated to inserting the <code>Sensitivity</code> struct into the extensions of each incoming request.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;B, S&gt; Service&lt;Request&lt;B&gt;&gt; for SensitivityInserter&lt;S&gt;
where
    S: Service&lt;Request&lt;B&gt;&gt;
{
    /* ... */

    fn call(&amp;mut self, request: Request&lt;B&gt;) -&gt; Self::Future {
        let sensitivity = Sensitivity {
            /* .. */
        };
        request.extensions_mut().insert(sensitivity);

        self.inner.call(request)
    }
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="advantages"><a class="header" href="#advantages">Advantages</a></h4>
<ul>
<li>Applicable to <em>all</em> middleware which takes <code>http::Request&lt;B&gt;</code>.</li>
<li>Does not pollute the API of the middleware - code internal to middleware simply inspects the request's extensions and performs logic based on its value.</li>
</ul>
<h4 id="disadvantages"><a class="header" href="#disadvantages">Disadvantages</a></h4>
<ul>
<li>The sensitivity and HTTP bindings are known at compile time whereas the insertion/retrieval of the extension data is done at runtime.
<ul>
<li><a href="https://docs.rs/http/latest/http/struct.Extensions.html">http::Extensions</a> is approximately a <code>HashMap&lt;u64, Box&lt;dyn Any&gt;&gt;</code> so lookup/insertion involves indirection/cache misses/heap allocation.</li>
</ul>
</li>
</ul>
<h3 id="accommodate-the-sensitivity-in-middleware-api"><a class="header" href="#accommodate-the-sensitivity-in-middleware-api">Accommodate the Sensitivity in Middleware API</a></h3>
<p>It is possible that sensitivity is a parameter passed to middleware during construction. This is similar in nature to <a href="#use-request-extensions">Use Request Extensions</a> except that the <code>Sensitivity</code> is passed to middleware during construction.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Middleware&lt;S&gt; {
    inner: S,
    sensitivity: Sensitivity
}

impl Middleware&lt;S&gt; {
    pub fn new(inner: S) -&gt; Self { /* ... */ }

    pub fn new_with_sensitivity(inner: S, sensitivity: Sensitivity) -&gt; Self { /* ... */ }
}

impl&lt;B, S&gt; Service&lt;Request&lt;B&gt;&gt; for Middleware&lt;S&gt; {
    /* ... */

    fn call(&amp;mut self, request: Request&lt;B&gt;) -&gt; Self::Future {
        if self.sensitivity.is_method_sensitive() {
            debug!(method = %Sensitive(request.method()));
        }

        /* ... */

        self.inner.call(request)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>It would then be required that the code generation responsible constructing a <code>Sensitivity</code> for each operation. Additionally, if any middleware is being applied to a operation then the code generation would be responsible for passing that middleware the appropriate <code>Sensitivity</code> before applying it.</p>
<h4 id="advantages-1"><a class="header" href="#advantages-1">Advantages</a></h4>
<ul>
<li>Applicable to <em>all</em> middleware.</li>
<li>As the <code>Sensitivity</code> struct will be known statically, the compiler will remove branches, making it cheap.</li>
</ul>
<h4 id="disadvantages-1"><a class="header" href="#disadvantages-1">Disadvantages</a></h4>
<ul>
<li>Pollutes the API of middleware.</li>
</ul>
<h3 id="redact-values-using-a-tracing-layer"><a class="header" href="#redact-values-using-a-tracing-layer">Redact values using a tracing Layer</a></h3>
<p>Distinct from <code>tower::Layer</code>, a <a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/layer/trait.Layer.html">tracing::Layer</a> is a &quot;composable handler for <code>tracing</code> events&quot;. It would be possible to write an implementation which would filter out events which contain sensitive data.</p>
<p>Examples of filtering <code>tracing::Layer</code>s already exist in the form of the <a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/filter/struct.EnvFilter.html">EnvFilter</a> and <a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/filter/targets/struct.Targets.html">Targets</a>. It is unlikely that we'll be able to leverage them for our use, but the underlying principle remains the same - the <code>tracing::Layer</code> inspects <code>tracing::Event</code>s/<code>tracing::Span</code>s, filtering them based on some criteria.</p>
<p>Code generation would be need to be used in order to produce the filtering criteria from the models. Internal developers would need to adhere to a common set of field names in order for them to be subject to the filtering. Spans would need to be opened after routing occurs in order for the <code>tracing::Layer</code> to know which operation <code>Event</code>s are being produced within and hence which filtering rules to apply.</p>
<h4 id="advantages-2"><a class="header" href="#advantages-2">Advantages</a></h4>
<ul>
<li>Applicable to <em>all</em> middleware.</li>
<li>Good separation of concerns:
<ul>
<li>Does not pollute the API of the middleware</li>
<li>No specific logic required within middleware.</li>
</ul>
</li>
</ul>
<h4 id="disadvantages-2"><a class="header" href="#disadvantages-2">Disadvantages</a></h4>
<ul>
<li>Complex implementation.</li>
<li>Not necessarily fast.</li>
<li><code>tracing::Layer</code>s seem to only support filtering entire <code>Event</code>s, rather than more fine grained removal of fields.</li>
</ul>
<h2 id="changes-checklist"><a class="header" href="#changes-checklist">Changes Checklist</a></h2>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Implement and integrate code generated logging middleware.
<ul>
<li>https://github.com/awslabs/smithy-rs/pull/1550</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
Add logging to <code>Router</code> implementation.</li>
<li><input disabled="" type="checkbox"/>
Write developer guideline.</li>
<li><input disabled="" type="checkbox"/>
Refactor <code>Router</code> to allow for better positioning described in <a href="#middleware-position">Middleware Position</a>.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rfcs/rfc0017_customizable_client_operations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../rfcs/rfc0019_event_streams_errors.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rfcs/rfc0017_customizable_client_operations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../rfcs/rfc0019_event_streams_errors.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../static/mermaid.min.js"></script>
        <script type="text/javascript" src="../static/mermaid-init.js"></script>


    </body>
</html>
